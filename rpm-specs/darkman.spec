# Generated by go2rpm 1.6.0
%bcond_without check

# https://gitlab.com/WhyNotHugo/darkman
%global  goipath        gitlab.com/WhyNotHugo/darkman
Version:                1.5.4
%global  tag            v%{version}

%gometa -f

%global common_description %{expand:
Daemon for dark-mode and light-mode transitions on Linux desktop.}

%global golicenses      LICENCE
%global godocs          examples CHANGELOG.md README.md

Name:           darkman
Release:        %autorelease
Summary:        Daemon for dark-mode and light-mode transitions on Linux desktop

License:        ISC
URL:            %{gourl}
Source0:        %{gosource}

# Fixed upstream https://gitlab.com/WhyNotHugo/darkman/-/commit/9403394dad6d148ac2da4317ecaf5c4da21beb0d
Patch0:         9403394dad6d148ac2da4317ecaf5c4da21beb0d.patch
# Fixed upstream https://gitlab.com/WhyNotHugo/darkman/-/commit/d0412f2a40b09bad014107ca2c13f9c7c100b7eb
Patch1:         d0412f2a40b09bad014107ca2c13f9c7c100b7eb.patch
# Fix proposed upstream https://gitlab.com/WhyNotHugo/darkman/-/merge_requests/24
Patch2:         0001-Update-astral-version.patch

BuildRequires:  scdoc
BuildRequires:  systemd-rpm-macros

Requires:       dbus-common

%description
%{common_description}

%gopkg

%prep
%goprep
%autopatch -p1

%generate_buildrequires
%go_generate_buildrequires

%build
for cmd in cmd/* ; do
  %gobuild -o %{gobuilddir}/bin/$(basename $cmd) %{goipath}/$cmd
done
scdoc < darkman.1.scd > darkman.1

%install
%gopkginstall
install -m 0755 -vd                     %{buildroot}%{_bindir}
install -m 0755 -vp %{gobuilddir}/bin/* %{buildroot}%{_bindir}/
install -m 0644 -Dp darkman.service     %{buildroot}%{_userunitdir}/darkman.service
install -m 0644 -Dp darkman.1           %{buildroot}%{_mandir}/man1/darkman.1
install -m 0644 -Dp contrib/dbus/nl.whynothugo.darkman.service %{buildroot}%{_datadir}/dbus-1/services/nl.whynothugo.darkman.service
install -m 0644 -Dp contrib/dbus/org.freedesktop.impl.portal.desktop.darkman.service %{buildroot}%{_datadir}/dbus-1/services/org.freedesktop.impl.portal.darkman.service
install -m 0644 -Dp contrib/portal/darkman.portal %{buildroot}%{_datadir}/xdg-desktop-portal/portals/darkman.portal

%if %{with check}
%check
%gocheck
%endif

%post
%systemd_user_post %{name}.service

%preun
%systemd_user_preun %{name}.service

%postun
%systemd_user_postun_with_restart %{name}.service

%files
%license LICENCE
%doc examples CHANGELOG.md README.md
%{_bindir}/darkman
%{_userunitdir}/darkman.service
%{_mandir}/man1/darkman.1.gz
%{_datadir}/dbus-1/services/*.service
%dir %{_datadir}/xdg-desktop-portal
%dir %{_datadir}/xdg-desktop-portal/portals/
%{_datadir}/xdg-desktop-portal/portals/darkman.portal

%gopkgfiles

%changelog
%autochangelog
