%global giturl  https://github.com/mcmtroffaes/sphinxcontrib-bibtex

Name:           python-sphinxcontrib-bibtex
Version:        2.6.3
Release:        %autorelease
Summary:        Sphinx extension for BibTeX style citations

License:        BSD-2-Clause
URL:            https://sphinxcontrib-bibtex.readthedocs.io/
VCS:            git:%{giturl}.git
Source:         %{giturl}/archive/%{version}/sphinxcontrib-bibtex-%{version}.tar.gz

BuildArch:      noarch

BuildRequires:  python3-devel
BuildRequires:  python3-docs
BuildRequires:  python-sphinx-doc
BuildRequires:  %{py3_dist cython}
BuildRequires:  %{py3_dist numpydoc}

%global common_desc %{expand:
This package contains a Sphinx extension for BibTeX style citations.

This extension allows BibTeX citations to be inserted into documentation
generated by Sphinx, via a bibliography directive, and a cite role,
which work similarly to LaTeX's thebibliography environment and \\cite
command.

For formatting, the extension relies on pybtex, written by Andrey
Golovizin.}

%description %common_desc

%package -n python3-sphinxcontrib-bibtex
Summary:        Sphinx extension for BibTeX style citations

%description -n python3-sphinxcontrib-bibtex %common_desc

%package doc
# In addition to the project license, the JavaScript and CSS bundled with the
# documentation has the following licenses:
# _static/alabaster.css: BSD-3-Clause
# _static/basic.css: BSD-2-Clause
# _static/custom.css: BSD-3-Clause
# _static/doctools.js: BSD-2-Clause
# _static/documentation_options.js: BSD-2-Clause
# _static/file.png: BSD-2-Clause
# _static/language_data.js: BSD-2-Clause
# _static/minus.png: BSD-2-Clause
# _static/plus.png: BSD-2-Clause
# _static/searchtools.js: BSD-2-Clause
# _static/sphinx_highlight.js: BSD-2-Clause
# genindex.html: BSD-2-Clause
# search.html: BSD-2-Clause
# searchindex.js: BSD-2-Clause
License:        BSD-2-Clause AND BSD-3-Clause
Summary:        Documentation for python-sphinxcontrib-bibtex

%description doc
Documentation for python-sphinxcontrib-bibtex.

%prep
%autosetup -p1 -n sphinxcontrib-bibtex-%{version}

# Use local objects.inv for intersphinx
sed -e 's|\("https://docs\.python\.org/3/", \)None|\1"%{_docdir}/python3-docs/html/objects.inv"|' \
    -e 's|\("http://www\.sphinx-doc\.org/en/master/", \)None|\1"%{_docdir}/python-sphinx-doc/html/objects.inv"|' \
    -i doc/conf.py

# Fedora does not have autoapi, so do not try to test with it
rm -fr test/test_autoapi.py test/roots/test-autoapi

%generate_buildrequires
%pyproject_buildrequires -x test

%build
%pyproject_wheel

%install
%pyproject_install
%pyproject_save_files -l 'sphinxcontrib*'

# The Sphinx documentation cannot be built with an uninstalled
# sphinxcontrib.bibtex because python finds the installed sphinxcontrib
# package, which doesn't contain bibtex.  We fake out python by copying the
# entire installed tree to a local directory and adding this package inside
# the sphinxcontrib directory.
mkdir lib
cp -a %{_prefix}/lib/python%{python3_version} lib
if [ -d %{_prefix}/lib64/python%{python3_version} ]; then
  mkdir lib64
  cp -a %{_prefix}/lib64/python%{python3_version} lib64
fi
mkdir include
cp -a %{_includedir}/python%{python3_version}* include
cp -a %{buildroot}%{python3_sitelib}/sphinxcontrib* \
      lib/python%{python3_version}/site-packages
export PYTHONHOME=$PWD:$PWD
sphinx-build doc html
rm -fr include lib lib64
rm -fr html/{.buildinfo,.doctrees}
unset PYTHONHOME
rst2html --no-datestamp README.rst README.html

%check
%pytest -v test

%files -n python3-sphinxcontrib-bibtex -f %{pyproject_files}
%doc README.html

%files doc
%doc html/*

%changelog
%autochangelog
